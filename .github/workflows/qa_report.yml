name: QA Report Generation

on:
  pull_request:
    branches: [main, "release*", "dev*"]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  merge_report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Set environment variables
        run: |
          echo "FBT_TOOLCHAIN_PATH=/tmp/toolchain" >> $GITHUB_ENV
      
      - name: 'Create toolchain directory with proper permissions'
        run: |
          sudo mkdir -p $FBT_TOOLCHAIN_PATH
          sudo chmod -R 777 $FBT_TOOLCHAIN_PATH
      
      - name: Install dependencies
        run: |
          python3 -m pip install slack_sdk
          
      - name: Generate merge report
        run: |
          # Initialize environment with our properly permissioned directory
          source scripts/toolchain/fbtenv.sh
          # Generate report
          python3 scripts/merge_report_qa.py
