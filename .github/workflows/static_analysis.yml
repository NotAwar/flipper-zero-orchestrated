name: Static C/C++ analysis with PVS-Studio

on:
  push:
    branches: [main, "release*", "dev*"]
  pull_request:
    branches: [main, "release*", "dev*"]
  workflow_dispatch:

jobs:
  analyse_c_cpp:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Set environment variables
        run: |
          echo "TARGETS=f7" >> $GITHUB_ENV
          echo "DEFAULT_TARGET=f7" >> $GITHUB_ENV
          echo "FBT_TOOLCHAIN_PATH=/tmp/toolchain" >> $GITHUB_ENV
          echo "FBT_GIT_SUBMODULE_SHALLOW=1" >> $GITHUB_ENV
          echo "SUFFIX=custom-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
          
      # Explicitly create toolchain directory first
      - name: Create toolchain directory with proper permissions
        run: |
          sudo mkdir -p /tmp/toolchain
          sudo chmod -R 777 /tmp/toolchain
      
      - name: Install PVS-Studio
        run: |
          wget -q -O - https://files.viva64.com/etc/pubkey.txt | sudo apt-key add -
          sudo wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list
          sudo apt-get update
          sudo apt-get install -y pvs-studio
      
      - name: Run PVS-Studio analysis
        run: |
          if [ -n "${{ secrets.PVS_STUDIO_CREDENTIALS }}" ]; then
            # License activation
            pvs-studio-analyzer credentials ${{ secrets.PVS_STUDIO_CREDENTIALS }} -o pvs-studio.lic
            
            # Prepare FBT environment
            ./fbt TARGET_HW=7 proto_ver
            
            # Run analysis
            pvs-studio-analyzer analyze -l pvs-studio.lic -o PVS-Studio.log
            plog-converter -a GA:1,2 -t fullhtml PVS-Studio.log -o pvs_report
          else
            echo "PVS-Studio credentials not found, skipping analysis"
            mkdir -p pvs_report
            echo "PVS-Studio analysis skipped - no credentials" > pvs_report/index.html
          fi
        
      - name: Upload PVS Studio report
        uses: actions/upload-artifact@v4
        with:
          name: pvs-studio-report
          path: pvs_report/
          retention-days: 14
